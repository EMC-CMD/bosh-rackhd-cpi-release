{
    "friendlyName": "Provision Node",
    "implementsTask": "Task.Base.Linux.Commands",
    "injectableName": "Task.Os.Install.CF.Stemcell",
    "options": {
      "agentSettingsFile": null,
      "agentSettingsMd5Uri": "{{ api.files }}/md5/{{ options.agentSettingsFile }}/latest",
      "agentSettingsPath": null,
      "agentSettingsUri": "{{ api.files }}/{{ options.agentSettingsFile }}/latest",
      "commands": [
        "curl --retry 3 {{ options.stemcellUri }} -o {{ options.downloadDir }}/{{ options.stemcellFile }}",
        "test `curl {{ options.stemcellFileMd5Uri }}` = \\\"`md5sum {{ options.downloadDir }}/{{ options.stemcellFile }}| awk '{print $1}'`\\\"",
        "curl --retry 3 {{ options.agentSettingsUri }} -o {{ options.downloadDir }}/{{ options.agentSettingsFile }}",
        "test `curl {{ options.agentSettingsMd5Uri }}` = \\\"`md5sum {{ options.downloadDir }}/{{ options.agentSettingsFile }}| awk '{print $1}'`\\\"",
        "curl --retry 3 {{ options.registrySettingsUri }} -o {{ options.downloadDir }}/{{ options.registrySettingsFile }}",
        "test `curl {{ options.registrySettingsMd5Uri }}` = \\\"`md5sum {{ options.downloadDir }}/{{ options.registrySettingsFile }}| awk '{print $1}'`\\\"",
        "curl --retry 3 {{ options.publicKeyUri }} -o {{ options.downloadDir }}/{{ options.publicKeyFile }}",
        "test `curl {{ options.publicKeyMd5Uri }}` = \\\"`md5sum {{ options.downloadDir }}/{{ options.publicKeyFile }}| awk '{print $1}'`\\\"",
        "sudo umount {{ options.device }} || true",
        "sudo tar --to-stdout -xvf {{ options.downloadDir }}/{{ options.stemcellFile }} | sudo dd of={{ options.device }}",
        "sudo sfdisk -R {{ options.device }}",
        "sudo mount {{ options.device }}1 /mnt",
        "sudo mkdir -p /mnt/home/vcap/.ssh",
        "sudo cat {{ options.downloadDir }}/{{ options.publicKeyFile }} >> /mnt/home/vcap/.ssh/authorized_keys",
        "sudo chown 1000:1000 /mnt/home/vcap/.ssh/authorized_keys",
        "sudo chown 1000:1000 /mnt/home/vcap/.ssh",
        "sudo chmod 600 /mnt/home/vcap/.ssh/authorized_keys",
        "sudo chmod 700 /mnt/home/vcap/.ssh/",
        "sudo cp {{ options.downloadDir }}/{{ options.agentSettingsFile }} /mnt/{{ options.agentSettingsPath }}",
        "sudo cp {{ options.downloadDir }}/{{ options.registrySettingsFile }} /mnt/{{ options.registrySettingsPath }}",
        "sudo sync"
      ],
      "device": "/dev/sda",
      "downloadDir": "/opt/downloads",
      "publicKeyFile": null,
      "publicKeyMd5Uri": "{{ api.files }}/md5/{{ options.publicKeyFile }}/latest",
      "publicKeyUri": "{{ api.files }}/{{ options.publicKeyFile }}/latest",
      "registrySettingsFile": null,
      "registrySettingsMd5Uri": "{{ api.files }}/md5/{{ options.registrySettingsFile }}/latest",
      "registrySettingsPath": null,
      "registrySettingsUri": "{{ api.files }}/{{ options.registrySettingsFile }}/latest",
      "stemcellFile": null,
      "stemcellFileMd5Uri": "{{ api.files }}/md5/{{ options.stemcellFile }}/latest",
      "stemcellUri": "{{ api.files }}/{{ options.stemcellFile }}/latest"
    },
    "properties": {}
  }
