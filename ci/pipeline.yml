---
groups:
  - name: bosh-rackhd-cpi
    jobs:
      - integration
      - lifecycle
      - bats-virtual
      - setup-director
      - teardown-director
      - promote-candidate

jobs:
- name: integration
  serial: true
  plan:
  - aggregate:
    - {trigger: false,   get: bosh-cpi-release,     resource: bosh-rackhd-cpi-release}
  - task: test
    file: bosh-cpi-release/ci/tasks/integration.yml
    config:
      params:
        RACKHD_API_URI:              {{rackhd_server_ip}}

- name: lifecycle
  serial: true
  plan:
  - aggregate:
    - {trigger: true,  passed: [integration],  get: bosh-cpi-release,   resource: bosh-rackhd-cpi-release}
    - {trigger: false,                         get: stemcell,           resource: rackhd-openstack-stemcell}
#  - put: vsphere-ubuntu-env
#    params: {acquire: true}
  - task: test
    file: bosh-cpi-release/ci/tasks/lifecycle.yml
    config:
      params:
        RACKHD_API_URI:               {{rackhd_server_ip}}
        AGENT_PUBLIC_KEY:             {{agent_public_key}}
        STATIC_IP:                    {{static_ip}}
        GATEWAY:                      {{gateway}}

- name: setup-director
  serial: true
  plan:
  - aggregate:
    - {trigger: true,  passed: [lifecycle], get: bosh-cpi-release,   resource: bosh-rackhd-cpi-release}
#  - get: vsphere-ubuntu-env
#    passed: [lifecycle]
  - task: setup-director
    file: bosh-cpi-release/ci/tasks/setup-director.yml
    config:
      params:
        BOSH_VSPHERE_DIRECTOR:              {{bosh_vsphere_director}}
        BOSH_DIRECTOR_PUBLIC_IP:            {{virtual_bosh_director_public_ip}}
        BOSH_DIRECTOR_PRIVATE_IP:           {{virtual_bosh_director_private_ip}}
        BOSH_DIRECTOR_PUBLIC_KEY:           {{director_public_key}}
        RACKHD_API_URI:                     {{rackhd_server_ip}}
        RACKHD_NETWORK:                     {{rackhd_network}}
        CPI_RELEASE_NAME:                   {{cpi_release_name}}
        DIRECTOR_DEPLOYMENT_NAME:           {{director_deployment_name}}

- name: bats-virtual
  serial: true
  plan:
  - aggregate:
    - {trigger: true,  passed: [setup-director],    get: bosh-cpi-release,   resource: bosh-rackhd-cpi-release}
    - {trigger: false, passed: [lifecycle],         get: stemcell,           resource: rackhd-openstack-stemcell}
    - {trigger: true,                               get: bats,               resource: bosh-acceptance-tests}
#  - get: vsphere-ubuntu-env
#    passed: [setup-director]
  - task: test
    file: bosh-cpi-release/ci/tasks/bats.yml
    config:
      params:
        AGENT_PUBLIC_KEY:                   {{agent_public_key}}
        BOSH_DIRECTOR_PUBLIC_IP:            {{virtual_bosh_director_public_ip}}
        BOSH_DIRECTOR_PRIVATE_IP:           {{virtual_bosh_director_private_ip}}
        SECONDARY_STATIC_IP:                {{virtual_secondary_static_ip}}
        PRIMARY_NETWORK_CIDR:               {{virtual_primary_network_cidr}}
        PRIMARY_NETWORK_GATEWAY:            {{virtual_primary_network_gateway}}
        PRIMARY_NETWORK_RANGE:              {{virtual_primary_network_range}}
        PRIMARY_NETWORK_MANUAL_IP:          {{virtual_primary_network_manual_ip}}
        BAT_SPEC:                           {{bat_spec}}

- name: teardown-director
  serial: true
  plan:
  - aggregate:
    - {trigger: true, passed: [bats-virtual], get: bosh-cpi-release,   resource: bosh-rackhd-cpi-release}
#  - get: vsphere-ubuntu-env
#    passed: [bats-virtual]
  - task: teardown-director
    file: bosh-cpi-release/ci/tasks/teardown-director.yml
    config:
      params:
        BOSH_VSPHERE_DIRECTOR:              {{bosh_vsphere_director}}
        CPI_RELEASE_NAME:                   {{cpi_release_name}}
        DIRECTOR_DEPLOYMENT_NAME:           {{director_deployment_name}}
#  - put: vsphere-ubuntu-env
#    params: {release: vsphere-ubuntu-env}

- name: promote-candidate
  serial: true
  plan:
  - aggregate:
    - {trigger: true, passed: [bats-virtual], get: bosh-cpi-release,   resource: bosh-rackhd-cpi-release}
    - {trigger: false, get: release-version-semver, params: {bump: major}}

  - task: promote
    file: bosh-cpi-release/ci/tasks/promote-candidate.yml
    config:
      params:
        S3_ACCESS_KEY_ID:     {{s3_access_key_id}}
        S3_SECRET_ACCESS_KEY: {{s3_secret_access_key}}
  - put: bosh-cpi-release-out
    params: {repository: promote/bosh-cpi-release, rebase: true, tag_prefix: "v", tag: promote/integer_version}

  - put: release-version-semver
    params: {file: release-version-semver/number}


resources:
  - &bosh-cpi-release-resource
    name: bosh-rackhd-cpi-release
    type: git
    source:
      uri: git@github.com:EMC-CMD/bosh-rackhd-cpi-release.git
      branch: master
      private_key: {{github_key__bosh-rackhd-cpi-release}}
      ignore_paths:
        - .final_builds/**/*.yml
        - releases/**/*.yml

  - <<: *bosh-cpi-release-resource
    name: bosh-cpi-release-out

  - name: rackhd-openstack-stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-openstack-kvm-ubuntu-trusty-go_agent-raw

  - name: bosh-acceptance-tests
    type: git
    source:
      uri: git@github.com:EMC-CMD/bosh-acceptance-tests.git
      branch: wip-branch
      private_key: {{github_key__bosh-acceptance-tests}}

  - name: vsphere-ubuntu-env
    type: pool
    source:
      uri: https://github.com/EMC-CMD/emccmd-environments.git
      branch: master
      pool: vsphere-ubuntu
      private_key: {{github_key__emccmd-environments}}

  - name: release-version-semver
    type: semver
    source:
      key:               release-current-version
      bucket:            {{s3_bucket_name}}
      access_key_id:     {{s3_access_key_id}}
      secret_access_key: {{s3_secret_access_key}}
